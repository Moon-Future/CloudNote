## Promise çš„å«ä¹‰

Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ¯”ä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆâ€”â€”å›è°ƒå‡½æ•°å’Œäº‹ä»¶â€”â€”æ›´åˆç†å’Œæ›´å¼ºå¤§ã€‚

Promise æœ‰ä»¥ä¸‹ä¸¤ä¸ªç‰¹ç‚¹ï¼š

1. å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–ç•Œå½±å“ã€‚

   ä¸‰ç§çŠ¶æ€ï¼špendingï¼ˆè¿›è¡Œä¸­ï¼‰ã€fulfilledï¼ˆå·²æˆåŠŸï¼‰å’Œ rejectedï¼ˆä»¥å¤±è´¥ï¼‰

2. ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ã€‚

`Promise`ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚é¦–å…ˆï¼Œæ— æ³•å–æ¶ˆ`Promise`ï¼Œä¸€æ—¦æ–°å»ºå®ƒå°±ä¼šç«‹å³æ‰§è¡Œï¼Œæ— æ³•ä¸­é€”å–æ¶ˆã€‚å…¶æ¬¡ï¼Œå¦‚æœä¸è®¾ç½®å›è°ƒå‡½æ•°ï¼Œ`Promise`å†…éƒ¨æŠ›å‡ºçš„é”™è¯¯ï¼Œä¸ä¼šååº”åˆ°å¤–éƒ¨ã€‚ç¬¬ä¸‰ï¼Œå½“å¤„äº`pending`çŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥ç›®å‰è¿›å±•åˆ°å“ªä¸€ä¸ªé˜¶æ®µï¼ˆåˆšåˆšå¼€å§‹è¿˜æ˜¯å³å°†å®Œæˆï¼‰ã€‚



[`Promise`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise) æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆå®Œæˆæˆ–è€…å¤±è´¥ã€‚ç”±äºå®ƒçš„`then`æ–¹æ³•å’Œ`catchã€finally`æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªæ–°çš„`Promise`æ‰€ä»¥å¯ä»¥å…è®¸æˆ‘ä»¬é“¾å¼è°ƒç”¨ï¼Œè§£å†³äº†ä¼ ç»Ÿçš„å›è°ƒåœ°ç‹±é—®é¢˜ã€‚

å†è¯´ä¸€ä¸‹`then`ä»¥åŠ`catch`æ–¹æ³•ï¼š

(æ­¤å¤„æˆ‘æ˜¯ç›´æ¥æ‹¿æˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« [ã€Š45é“Promiseé¢˜ã€‹](https://juejin.im/post/6844904077537574919#heading-16)é‚£é‡Œçš„æ€»ç»“)

1. `Promise`çš„çŠ¶æ€ä¸€ç»æ”¹å˜å°±ä¸èƒ½å†æ”¹å˜ã€‚(è§3.1)
2. `.then`å’Œ`.catch`éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„`Promise`ã€‚(ä¸Šé¢çš„ğŸ‘†1.4è¯æ˜äº†)
3. `catch`ä¸ç®¡è¢«è¿æ¥åˆ°å“ªé‡Œï¼Œéƒ½èƒ½æ•è·ä¸Šå±‚æœªæ•æ‰è¿‡çš„é”™è¯¯ã€‚(è§3.2)
4. åœ¨`Promise`ä¸­ï¼Œè¿”å›ä»»æ„ä¸€ä¸ªé `promise` çš„å€¼éƒ½ä¼šè¢«åŒ…è£¹æˆ `promise` å¯¹è±¡ï¼Œä¾‹å¦‚`return 2`ä¼šè¢«åŒ…è£…ä¸º`return Promise.resolve(2)`ã€‚
5. `Promise` çš„ `.then` æˆ–è€… `.catch` å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡, ä½†å¦‚æœ`Promise`å†…éƒ¨çš„çŠ¶æ€ä¸€ç»æ”¹å˜ï¼Œå¹¶ä¸”æœ‰äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåç»­æ¯æ¬¡è°ƒç”¨`.then`æˆ–è€…`.catch`çš„æ—¶å€™éƒ½ä¼šç›´æ¥æ‹¿åˆ°è¯¥å€¼ã€‚(è§3.5)
6. `.then` æˆ–è€… `.catch` ä¸­ `return` ä¸€ä¸ª `error` å¯¹è±¡å¹¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œæ‰€ä»¥ä¸ä¼šè¢«åç»­çš„ `.catch` æ•è·ã€‚(è§3.6)
7. `.then` æˆ– `.catch` è¿”å›çš„å€¼ä¸èƒ½æ˜¯ promise æœ¬èº«ï¼Œå¦åˆ™ä¼šé€ æˆæ­»å¾ªç¯ã€‚(è§3.7)
8. `.then` æˆ–è€… `.catch` çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éå‡½æ•°åˆ™ä¼šå‘ç”Ÿå€¼é€ä¼ ã€‚(è§3.8)
9. `.then`æ–¹æ³•æ˜¯èƒ½æ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„ï¼Œç¬¬ä¸€ä¸ªæ˜¯å¤„ç†æˆåŠŸçš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªæ˜¯å¤„ç†å¤±è´¥çš„å‡½æ•°ï¼Œå†æŸäº›æ—¶å€™ä½ å¯ä»¥è®¤ä¸º`catch`æ˜¯`.then`ç¬¬äºŒä¸ªå‚æ•°çš„ç®€ä¾¿å†™æ³•ã€‚(è§3.9)
10. `.finally`æ–¹æ³•ä¹Ÿæ˜¯è¿”å›ä¸€ä¸ª`Promise`ï¼Œä»–åœ¨`Promise`ç»“æŸçš„æ—¶å€™ï¼Œæ— è®ºç»“æœä¸º`resolved`è¿˜æ˜¯`rejected`ï¼Œéƒ½ä¼šæ‰§è¡Œé‡Œé¢çš„å›è°ƒå‡½æ•°ã€‚

å¦å¤–ä¹Ÿå¯ä»¥è¯´ä¸€ä¸‹`finally`æ–¹æ³•ï¼š

1. `.finally()`æ–¹æ³•ä¸ç®¡`Promise`å¯¹è±¡æœ€åçš„çŠ¶æ€å¦‚ä½•éƒ½ä¼šæ‰§è¡Œ
2. `.finally()`æ–¹æ³•çš„å›è°ƒå‡½æ•°ä¸æ¥å—ä»»ä½•çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ åœ¨`.finally()`å‡½æ•°ä¸­æ˜¯æ²¡æ³•çŸ¥é“`Promise`æœ€ç»ˆçš„çŠ¶æ€æ˜¯`resolved`è¿˜æ˜¯`rejected`çš„
3. å®ƒæœ€ç»ˆè¿”å›çš„é»˜è®¤ä¼šæ˜¯ä¸€ä¸ª**ä¸Šä¸€æ¬¡çš„Promiseå¯¹è±¡å€¼**ï¼Œä¸è¿‡å¦‚æœæŠ›å‡ºçš„æ˜¯ä¸€ä¸ªå¼‚å¸¸åˆ™è¿”å›å¼‚å¸¸çš„`Promise`å¯¹è±¡ã€‚

æœ€åå¯ä»¥è¯´ä¸€ä¸‹`all`ä»¥åŠ`race`æ–¹æ³•ï¼š

- `Promise.all()`çš„ä½œç”¨æ˜¯æ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œåæ‰æ‰§è¡Œå›è°ƒã€‚
- `.race()`çš„ä½œç”¨ä¹Ÿæ˜¯æ¥æ”¶ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œåªä¿ç•™å–ç¬¬ä¸€ä¸ªæ‰§è¡Œå®Œæˆçš„å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå…¶ä»–çš„æ–¹æ³•ä»åœ¨æ‰§è¡Œï¼Œä¸è¿‡æ‰§è¡Œç»“æœä¼šè¢«æŠ›å¼ƒã€‚
- `Promise.all().then()`ç»“æœä¸­æ•°ç»„çš„é¡ºåºå’Œ`Promise.all()`æ¥æ”¶åˆ°çš„æ•°ç»„é¡ºåºä¸€è‡´ã€‚
- `allå’Œrace`ä¼ å…¥çš„æ•°ç»„ä¸­å¦‚æœæœ‰ä¼šæŠ›å‡ºå¼‚å¸¸çš„å¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆåªæœ‰æœ€å…ˆæŠ›å‡ºçš„é”™è¯¯ä¼šè¢«æ•è·ï¼Œå¹¶ä¸”æ˜¯è¢«`then`çš„ç¬¬äºŒä¸ªå‚æ•°æˆ–è€…åé¢çš„`catch`æ•è·ï¼›ä½†å¹¶ä¸ä¼šå½±å“æ•°ç»„ä¸­å…¶å®ƒçš„å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚



## å®ç°

```js
function resolvePromise(promise2,x,resolve,reject){
    //åˆ¤æ–­xæ˜¯ä¸æ˜¯promise
    //è§„èŒƒä¸­è§„å®šï¼šæˆ‘ä»¬å…è®¸åˆ«äººä¹±å†™ï¼Œè¿™ä¸ªä»£ç å¯ä»¥å®ç°æˆ‘ä»¬çš„promiseå’Œåˆ«äººçš„promise è¿›è¡Œäº¤äº’
    if(promise2 === x){//ä¸èƒ½è‡ªå·±ç­‰å¾…è‡ªå·±å®Œæˆ
        return reject(new TypeError('å¾ªç¯å¼•ç”¨'));
    };
    // xæ˜¯é™¤äº†nullä»¥å¤–çš„å¯¹è±¡æˆ–è€…å‡½æ•°
    if(x !=null && (typeof x === 'object' || typeof x === 'function')){
        let called;//é˜²æ­¢æˆåŠŸåè°ƒç”¨å¤±è´¥
        try{//é˜²æ­¢å–thenæ˜¯å‡ºç°å¼‚å¸¸  object.defineProperty
            let then = x.then;//å–xçš„thenæ–¹æ³• {then:{}}
            if(typeof then === 'function'){//å¦‚æœthenæ˜¯å‡½æ•°å°±è®¤ä¸ºä»–æ˜¯promise
                //callç¬¬ä¸€ä¸ªå‚æ•°æ˜¯thisï¼Œåé¢çš„æ˜¯æˆåŠŸçš„å›è°ƒå’Œå¤±è´¥çš„å›è°ƒ
                then.call(x,y => {//å¦‚æœYæ˜¯promiseå°±ç»§ç»­é€’å½’promise
                    if(called) return;
                    called = true;
                    resolvePromise(promise2,y,resolve,reject)
                },r => { //åªè¦å¤±è´¥äº†å°±å¤±è´¥äº†
                    if(called) return;
                    called = true;
                    reject(r);  
                });
            }else{//thenæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå°±ç›´æ¥æˆåŠŸå³å¯
                resolve(x);
            }
        }catch (e){
            if(called) return;
            called = true;
            reject(e)
        }
    }else{//x = 123 xå°±æ˜¯ä¸€ä¸ªæ™®é€šå€¼ ä½œä¸ºä¸‹ä¸ªthenæˆåŠŸçš„å‚æ•°
        resolve(x)
    }

}

class Promise {
    constructor (executor){
        //é»˜è®¤çŠ¶æ€æ˜¯ç­‰å¾…çŠ¶æ€
        this.status = 'panding';
        this.value = undefined;
        this.reason = undefined;
        //å­˜æ”¾æˆåŠŸçš„å›è°ƒ
        this.onResolvedCallbacks = [];
        //å­˜æ”¾å¤±è´¥çš„å›è°ƒ
        this.onRejectedCallbacks = [];
        let resolve = (data) => {//thisæŒ‡çš„æ˜¯å®ä¾‹
            if(this.status === 'pending'){
                this.value = data;
                this.status = "resolved";
                this.onResolvedCallbacks.forEach(fn => fn());
            }
 
        }
        let reject = (reason) => {
            if(this.status === 'pending'){
                this.reason = reason;
                this.status = 'rejected';
                this.onRejectedCallbacks.forEach(fn => fn());
            }
        }
        try{//æ‰§è¡Œæ—¶å¯èƒ½ä¼šå‘ç”Ÿå¼‚å¸¸
            executor(resolve,reject);
        }catch (e){
            reject(e);//promiseå¤±è´¥äº†
        }
       
    }
    then(onFuiFilled,onRejected){ 
        //é˜²æ­¢å€¼å¾—ç©¿é€ 
        onFuiFilled = typeof onFuiFilled === 'function' ? onFuiFilled : y => y;
        onRejected = typeof onRejected === 'function' ? onRejected :err => {throw err;}        
        let promise2;//ä½œä¸ºä¸‹ä¸€æ¬¡thenæ–¹æ³•çš„promise
       if(this.status === 'resolved'){
           promise2 = new Promise((resolve,reject) => {
               setTimeout(() => {
                  try{
                        //æˆåŠŸçš„é€»è¾‘ å¤±è´¥çš„é€»è¾‘
                        let x = onFuiFilled(this.value);
                        //çœ‹xæ˜¯ä¸æ˜¯promise å¦‚æœæ˜¯promiseå–ä»–çš„ç»“æœ ä½œä¸ºpromise2æˆåŠŸçš„çš„ç»“æœ
                        //å¦‚æœè¿”å›ä¸€ä¸ªæ™®é€šå€¼ï¼Œä½œä¸ºpromise2æˆåŠŸçš„ç»“æœ
                        //resolvePromiseå¯ä»¥è§£æxå’Œpromise2ä¹‹é—´çš„å…³ç³»
                        //åœ¨resolvePromiseä¸­ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿”å›çš„promiseï¼Œç¬¬äºŒä¸ªæ˜¯è¿”å›çš„ç»“æœï¼Œç¬¬ä¸‰ä¸ªå’Œç¬¬å››ä¸ªåˆ†åˆ«æ˜¯resolve()å’Œreject()çš„æ–¹æ³•ã€‚
                        resolvePromise(promise2,x,resolve,reject)
                  }catch(e){
                        reject(e);
                  } 
               },0)
           }); 
       } 
       if(this.status === 'rejected'){
            promise2 = new Promise((resolve,reject) => {
                setTimeout(() => {
                    try{
                        let x = onRejected(this.reason);
                        //åœ¨resolvePromiseä¸­ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿”å›çš„promiseï¼Œç¬¬äºŒä¸ªæ˜¯è¿”å›çš„ç»“æœï¼Œç¬¬ä¸‰ä¸ªå’Œç¬¬å››ä¸ªåˆ†åˆ«æ˜¯resolve()å’Œreject()çš„æ–¹æ³•ã€‚
                        resolvePromise(promise2,x,resolve,reject)
                    }catch(e){
                        reject(e);
                    }
                },0)

            });
       }
       //å½“å‰æ—¢æ²¡æœ‰å®Œæˆä¹Ÿæ²¡æœ‰å¤±è´¥
       if(this.status === 'pending'){
           promise2 = new Promise((resolve,reject) => {
               //æŠŠæˆåŠŸçš„å‡½æ•°ä¸€ä¸ªä¸ªå­˜æ”¾åˆ°æˆåŠŸå›è°ƒå‡½æ•°æ•°ç»„ä¸­
                this.onResolvedCallbacks.push( () =>{
                    setTimeout(() => {
                        try{
                            let x = onFuiFilled(this.value);
                            resolvePromise(promise2,x,resolve,reject);
                        }catch(e){
                            reject(e);
                        }
                    },0)
                });
                //æŠŠå¤±è´¥çš„å‡½æ•°ä¸€ä¸ªä¸ªå­˜æ”¾åˆ°å¤±è´¥å›è°ƒå‡½æ•°æ•°ç»„ä¸­
                this.onRejectedCallbacks.push( ()=>{
                    setTimeout(() => {
                        try{
                            let x = onRejected(this.reason);
                            resolvePromise(promise2,x,resolve,reject)
                        }catch(e){
                            reject(e)
                        }
                    },0)
                })
           })
       }
       return promise2;//è°ƒç”¨thenåè¿”å›ä¸€ä¸ªæ–°çš„promise
    }
    catch (onRejected) {
        // catch æ–¹æ³•å°±æ˜¯thenæ–¹æ³•æ²¡æœ‰æˆåŠŸçš„ç®€å†™
        return this.then(null, onRejected);
    }
}
Promise.all = function (promises) {
    //promisesæ˜¯ä¸€ä¸ªpromiseçš„æ•°ç»„
    return new Promise(function (resolve, reject) {
        let arr = []; //arræ˜¯æœ€ç»ˆè¿”å›å€¼çš„ç»“æœ
        let i = 0; // è¡¨ç¤ºæˆåŠŸäº†å¤šå°‘æ¬¡
        function processData(index, data) {
            arr[index] = data;
            if (++i === promises.length) {
                resolve(arr);
            }
        }
        for (let j = 0; j < promises.length; j++) {
            promises[j].then(function (data) {
                processData(j, data)
            }, reject)
        }
    })
}
// åªè¦æœ‰ä¸€ä¸ªpromiseæˆåŠŸäº† å°±ç®—æˆåŠŸã€‚å¦‚æœç¬¬ä¸€ä¸ªå¤±è´¥äº†å°±å¤±è´¥äº†
Promise.race = function (promises) {
    return new Promise((resolve, reject) => {
        for (var i = 0; i < promises.length; i++) {
            promises[i].then(res => {
                resolve(res)
            }, err => {
                reject(err)
            })
        }
    })
}

// Promise.allSettled() æ–¹æ³•è¿”å›ä¸€ä¸ªåœ¨æ‰€æœ‰ç»™å®šçš„ promise å·²è¢«å†³è®®æˆ–è¢«æ‹’ç»åå†³è®®çš„ promiseï¼Œå¹¶å¸¦æœ‰ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡è¡¨ç¤ºå¯¹åº”çš„ promise ç»“æœã€‚
Promise.allSettled = function (promiseArr) {
    let results = [];
    return new Promise((resolve, reject) => {
        let i = 0, n = 0;
        // è¿è¡Œæ‰€æœ‰çš„ Promise
        while (n < promiseArr.length) {
            promiseArr[n].then(res => {
                // å½“æœ‰ Promise è¢« resolve ä¹‹åï¼Œè®°å½• resolve å€¼å’ŒçŠ¶æ€ï¼Œå·²å†³ Promise è®¡æ•°åŠ ä¸€
                results.push({value: res, status: 'fulfilled'});
                i++;
                // å…¨éƒ¨ Promise å·²å†³ï¼Œresolve
                if (i === promiseArr.length) {
                    resolve(results);
                }
            }).catch(err => {
                // å½“æœ‰ Promise è¢« reject åï¼Œè®°å½• reject å€¼å’ŒçŠ¶æ€ï¼Œå¹¶ä¸”å·²å†³çš„ Promise è®¡æ•°åŠ ä¸€
                results.push({value: err, status: 'rejected'});
                i++;
                if (i === promiseArr.length) {
                    resolve(results);
                }
            });
            n++;
        }
    })
}

// ç”Ÿæˆä¸€ä¸ªæˆåŠŸçš„promise
Promise.resolve = function(value){
    return new Promise((resolve,reject) => resolve(value);
}
// ç”Ÿæˆä¸€ä¸ªå¤±è´¥çš„promise
Promise.reject = function(reason){
    return new Promise((resolve,reject) => reject(reason));
}
Promise.defer = Promise.deferred = function () {
    let dfd = {};
    dfd.promise = new Promise( (resolve, reject) =>  {
        dfd.resolve = resolve;
        dfd.reject = reject;
    });
    return dfd
}
module.exports = Promise;
```

## ä½¿ç”¨Promiseå®ç°çº¢ç»¿ç¯äº¤æ›¿é‡å¤äº®

```js
function red() {
  console.log("red");
}
function green() {
  console.log("green");
}
function yellow() {
  console.log("yellow");
}
const light = function (timer, cb) {
  return new Promise(resolve => {
    setTimeout(() => {
      cb()
      resolve()
    }, timer)
  })
}
const step = function () {
  Promise.resolve().then(() => {
    return light(3000, red)
  }).then(() => {
    return light(2000, green)
  }).then(() => {
    return light(1000, yellow)
  }).then(() => {
    return step()
  })
}

step();
```

## ä½¿ç”¨Promiseå®ç°æ¯éš”1ç§’è¾“å‡º1,2,3

```js
const arr = [1, 2, 3]
arr.reduce((p, x) => {
  return p.then(() => {
    return new Promise(r => {
      setTimeout(() => r(console.log(x)), 1000)
    })
  })
}, Promise.resolve())
```

## å®ç°mergePromiseå‡½æ•°

```js
const time = (timer) => {
  return new Promise(resolve => {
    setTimeout(() => {
      resolve()
    }, timer)
  })
}
const ajax1 = () => time(2000).then(() => {
  console.log(1);
  return 1
})
const ajax2 = () => time(1000).then(() => {
  console.log(2);
  return 2
})
const ajax3 = () => time(1000).then(() => {
  console.log(3);
  return 3
})

function mergePromise (ajaxArray) {
  // å­˜æ”¾æ¯ä¸ªajaxçš„ç»“æœ
  const data = [];
  let promise = Promise.resolve();
  ajaxArray.forEach(ajax => {
  	// ç¬¬ä¸€æ¬¡çš„thenä¸ºäº†ç”¨æ¥è°ƒç”¨ajax
  	// ç¬¬äºŒæ¬¡çš„thenæ˜¯ä¸ºäº†è·å–ajaxçš„ç»“æœ
    promise = promise.then(ajax).then(res => {
      data.push(res);
      return data; // æŠŠæ¯æ¬¡çš„ç»“æœè¿”å›
    })
  })
  // æœ€åå¾—åˆ°çš„promiseå®ƒçš„å€¼å°±æ˜¯data
  return promise;
}

mergePromise([ajax1, ajax2, ajax3]).then(data => {
  console.log("done");
  console.log(data); // data ä¸º [1, 2, 3]
})
```

## å°è£…ä¸€ä¸ªå¼‚æ­¥åŠ è½½å›¾ç‰‡çš„æ–¹æ³•

```js
function loadImg(url) {
  return new Promise((resolve, reject) => {
    const img = new Image()
    img.onload = function() {
      console.log('ä¸€å¼ å›¾ç‰‡åŠ è½½å®Œæˆ')
      resolve(img)
    }
    img.onerror = function() {
      reject(new Error('Could not load image at' + url))
    }
    img.src = url
  })
}
```

## é™åˆ¶å¼‚æ­¥æ“ä½œçš„å¹¶å‘ä¸ªæ•°å¹¶å°½å¯èƒ½å¿«çš„å®Œæˆå…¨éƒ¨